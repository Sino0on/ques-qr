<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ gallery.title|default:"New Year Gallery" }}</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --ice:#6ec1ff; --ice-2:#b5e1ff; --dark:#0a0f16; --soft:#eef6ff; --card:#0e1a27; --grad1:#0b1724; --grad2:#0a1320;
    }
    html,body{height:100%;}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(110, 193, 255, .10), transparent),
                  linear-gradient(180deg, var(--grad1), var(--grad2));
      color:#eef6ff;
      overflow-x:hidden;
      background-repeat: no-repeat, no-repeat;
      background-size: 120% 100%, cover;
      background-attachment: fixed, fixed;
    }

    /* Snow loader */
    .loader{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:radial-gradient(1000px 400px at 50% 0%, rgba(110,193,255,.16), rgba(0,0,0,.6)), #081019; z-index:60; }
    .flake{ width:70px; height:70px; position:relative; animation:spin 3s linear infinite; filter: drop-shadow(0 10px 25px rgba(110,193,255,.35)); }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Snow background */
    .snow-bg{ position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
    .snow-bg span{ position:absolute; width:8px; height:8px; background:rgba(181,225,255,.9); border-radius:50%; box-shadow:0 0 12px rgba(110,193,255,.35); animation: fall 9s linear infinite; }
    @keyframes fall{ 0%{ transform: translateY(-10vh); opacity:0; } 10%{opacity:.9;} 100%{ transform: translateY(110vh); opacity:0; } }

    .glass{ background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); box-shadow: 0 10px 30px rgba(0,0,0,.25); backdrop-filter: blur(10px); }

    /* Grids */
    .gridx{ display:grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 640px){ .gridx{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1024px){ .gridx{ grid-template-columns: repeat(3, 1fr); } }

    .grid5{ display:grid; gap: 1rem; grid-template-columns: 1fr; }
    @media (min-width: 768px){
      .grid5{ grid-template-columns: repeat(4, 1fr); grid-template-rows: auto; }
      .cell-A{ grid-column: 1 / span 2; grid-row: 1 / span 2; }
      .cell-B{ grid-column: 3 / span 1; grid-row: 1; }
      .cell-C{ grid-column: 4 / span 1; grid-row: 1; }
      .cell-D{ grid-column: 3 / span 1; grid-row: 2; }
      .cell-E{ grid-column: 4 / span 1; grid-row: 2; }
    }

    .masonry-item{ border-radius: 16px; overflow:hidden; background: rgba(255,255,255,.05); border:2px solid rgba(255,255,255,.14); box-shadow: 0 0 0 3px rgba(110,193,255,.16) inset, 0 10px 30px rgba(0,0,0,.18); transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease; display:flex; flex-direction:column; }
    .masonry-item:hover{ transform: translateY(-3px); box-shadow: 0 12px 30px rgba(110,193,255,.22); border-color: rgba(110,193,255,.55); }
    .caption{ padding: 12px 14px; color:#e9f4ff; font-size: 14px; }

    .media-frame{ position:relative; width:100%; padding:18px; background: radial-gradient(circle at 50% 0%, rgba(110,193,255,.22), rgba(8,16,25,.7)); border-radius:14px; display:flex; align-items:center; justify-content:center; min-height:300px; }
    .grid5 .cell-A .media-frame{ min-height:380px; }
    .media-frame::after{ content:""; position:absolute; inset:12px; border-radius:12px; border:1px dashed rgba(183,228,255,.35); pointer-events:none; }
    .media-frame img,
    .media-frame video{ position:relative; max-width:100%; max-height:100%; border-radius:12px; box-shadow:0 8px 26px rgba(0,0,0,.25); object-fit:contain; }
    .media-frame video{ background:#000; }

    @media (max-width: 640px){
      .media-frame{ min-height:240px; padding:14px; }
      .grid5 .cell-A .media-frame{ min-height:300px; }
    }

    /* Actions */
    .actions{ position:absolute; top:10px; right:10px; display:flex; gap:8px; opacity:0; transform: translateY(-4px); transition: opacity .2s ease, transform .2s ease; }
    .masonry-item:hover .actions{ opacity:1; transform: translateY(0); }
    .btn-ghost{ padding:6px 10px; border-radius:999px; background: rgba(12,16,22,.45); border:1px solid rgba(255,255,255,.14); color:#fff; font-size:12px; backdrop-filter: blur(6px); }
    .btn-ghost:hover{ background: rgba(110,193,255,.25); border-color: rgba(110,193,255,.45); }

    /* FAB */
    .fab{ position:fixed; right:20px; top:20px; z-index:40; width:56px; height:56px; border-radius:999px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, var(--ice), var(--ice-2)); color:#0a1320; box-shadow: 0 12px 28px rgba(110,193,255,.35), inset 0 0 18px rgba(255,255,255,.25); }
    .fab:hover{ filter: saturate(1.08); transform: translateY(-1px); transition: transform .15s ease; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(9,12,16,.75); z-index:60; padding: 16px; }
    .modal.open{ display:flex; }
    .modal-card{ width:100%; max-width: 720px; border-radius: 16px; }
  </style>
</head>
<body>

  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="flex flex-col items-center gap-6">
      <svg class="flake" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v20M4 6l16 12M20 6L4 18M2 12h20" />
      </svg>
      <div class="text-sky-200/90 text-sm tracking-wide">Пусть идёт мягкий снег воспоминаний…</div>
    </div>
  </div>

  <!-- Snowflakes background -->
  <div class="snow-bg" id="snow"></div>

  <div class="relative z-10 min-h-screen">
    <!-- FAB -->
    <button id="fabUpload" aria-label="Добавить" class="fab">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14"/>
      </svg>
    </button>

    <header class="pt-10 sm:pt-14 text-center">
      <h1 class="text-4xl sm:text-5xl md:text-6xl font-semibold text-sky-300">
        {{ gallery.get_occasion_display|default:"С Новым годом" }} ❄️
      </h1>
      {% if gallery.title %}
        <p class="mt-3 text-sky-100/85 text-lg">{{ gallery.title }}</p>
      {% endif %}
      <p class="mt-1 text-sky-100/70 text-sm">Галерея по ссылке: <span class="text-sky-200/95 font-medium">/g/{{ gallery.public_url_slug }}</span></p>
    </header>

    <main class="mx-auto max-w-6xl px-4 sm:px-6 pb-24">
      <div class="mt-6 space-y-2">
        {% if messages %}
          {% for m in messages %}
            <div class="glass rounded-xl px-4 py-3 border text-sky-100 border-white/10">{{ m }}</div>
          {% endfor %}
        {% endif %}
      </div>

      <!-- Upload Modal -->
      <div id="uploadModal" class="modal">
        <div class="modal-card glass border p-5 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Добавить воспоминания</h2>
            <button id="closeUpload" class="px-3 py-1 rounded bg-sky-600 hover:bg-sky-500 transition text-white" type="button">Закрыть</button>
          </div>
          <form id="uploadForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div id="dropzone" class="p-5 sm:p-6 border border-white/10 rounded-xl" style="background: rgba(255,255,255,.06)">
              <div class="flex flex-col items-center gap-2 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-sky-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2" d="M3 15a4 4 0 014-4h1m6 0h1a4 4 0 110 8H7a4 4 0 01-4-4m7-6l2-2m0 0l2 2m-2-2v8" />
                </svg>
                <p class="text-sky-100/90"><span class="font-semibold">Перетащите</span> сюда файлы или <span class="font-semibold">выберите</span></p>
                <input id="fileInput" class="mt-3 block w-full text-sm text-sky-50/90" type="file" name="files" accept="image/*,video/*" multiple required />
                <div class="w-full grid gap-3 sm:grid-cols-3 mt-4">
                  <input type="text" name="caption" maxlength="200" placeholder="Подпись (для всех файлов)"
                    class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 placeholder-sky-100/40 focus:outline-none focus:ring-2 focus:ring-sky-500/60">
                  <input type="number" name="sort_order" min="0" placeholder="Порядок (начиная с)"
                    class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 placeholder-sky-100/40 focus:outline-none focus:ring-2 focus:ring-sky-500/60">
                  {% if need_pin %}
                  <input type="text" name="pin" maxlength="12" placeholder="PIN для загрузки"
                    class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 placeholder-sky-100/40 focus:outline-none focus:ring-2 focus:ring-sky-500/60">
                  {% endif %}
                  <button type="submit" class="px-4 py-2 rounded-full bg-sky-600 hover:bg-sky-500 transition text-white w-full sm:w-auto">Загрузить</button>
                </div>
                <p class="text-xs text-sky-100/70 mt-2">Фото и видео. Лимит — {{ max_mb }} МБ на файл.</p>
              </div>
            </div>
          </form>
        </div>
      </div>

      {% if not media_items %}
        <div class="text-center mt-12 text-sky-100/85">Пока пусто — добавьте первые снежные моменты ❄️</div>
      {% endif %}

      <section class="mt-8 pb-8">
        {% if media_items|length == 5 %}
        <div class="grid5" id="galleryGrid">
          {% for item in media_items %}
            <article class="masonry-item group relative {% if forloop.counter == 1 %}cell-A{% elif forloop.counter == 2 %}cell-B{% elif forloop.counter == 3 %}cell-C{% elif forloop.counter == 4 %}cell-D{% elif forloop.counter == 5 %}cell-E{% endif %}">
              <div class="actions">
                <form method="post" action="{% url 'media_delete' uuid=gallery.uuid item_id=item.id %}" onsubmit="return confirm('Удалить этот медиафайл?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-ghost">Удалить</button>
                </form>
              </div>
              <div class="media-frame">
                {% if item.kind == "image" %}
                  <img src="{{ item.file.url }}" alt="{{ item.caption }}" loading="lazy">
                {% elif item.kind == "video" %}
                  <video controls preload="metadata">
                    <source src="{{ item.file.url }}#t=0.1" type="{{ item.mime_type }}">
                  </video>
                {% endif %}
              </div>
              {% if item.caption %}<div class="caption">{{ item.caption }}</div>{% endif %}
            </article>
          {% endfor %}
        </div>
        {% else %}
        <div class="gridx" id="galleryGrid">
          {% for item in media_items %}
            <article class="masonry-item group relative">
              <div class="actions">
                <form method="post" action="{% url 'media_delete' uuid=gallery.uuid item_id=item.id %}" onsubmit="return confirm('Удалить этот медиафайл?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-ghost">Удалить</button>
                </form>
              </div>
              <div class="media-frame">
                {% if item.kind == "image" %}
                  <img src="{{ item.file.url }}" alt="{{ item.caption }}" loading="lazy">
                {% elif item.kind == "video" %}
                  <video controls preload="metadata">
                    <source src="{{ item.file.url }}#t=0.1" type="{{ item.mime_type }}">
                  </video>
                {% endif %}
              </div>
              {% if item.caption %}<div class="caption">{{ item.caption }}</div>{% endif %}
            </article>
          {% endfor %}
        </div>
        {% endif %}
      </section>
    </main>
  </div>

  <script>
    // Loader hide
    window.addEventListener('load', () => {
      const loader = document.getElementById('loader');
      loader.style.opacity = '0';
      loader.style.transition = 'opacity .6s ease';
      setTimeout(() => loader.style.display = 'none', 600);
    });

    // Snow generation
    const snow = document.getElementById('snow');
    const COUNT = 42;
    for(let i=0;i<COUNT;i++){
      const s = document.createElement('span');
      s.style.left = Math.random()*100 + 'vw';
      s.style.animationDelay = (Math.random()*8) + 's';
      const scale = .6 + Math.random()*1.2;
      s.style.transform = `scale(${scale})`;
      snow.appendChild(s);
    }

    // Upload modal controls
    const fab = document.getElementById('fabUpload');
    const modal = document.getElementById('uploadModal');
    const closeBtn = document.getElementById('closeUpload');
    fab.addEventListener('click', ()=> modal.classList.add('open'));
    closeBtn.addEventListener('click', ()=> modal.classList.remove('open'));
    modal.addEventListener('click', (e)=>{ if(e.target === modal){ modal.classList.remove('open'); }});
  </script>
</body>
</html>


