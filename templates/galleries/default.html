<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>{{ gallery.title|default:"–ú–æ—è –≥–∞–ª–µ—Ä–µ—è" }}</title>
  {% load static %}
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fafafa; margin:0; }
    header { text-align:center; padding:24px 16px; }
    h1 { margin:0 0 6px; font-size:28px; }
    .sub { color:#666; }
    .wrap { max-width:1000px; margin:0 auto; padding:0 16px 60px; }

    .grid { display:grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap:16px; margin-top:20px; }
    @media (min-width: 700px){ .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1024px){ .grid { grid-template-columns: repeat(3, 1fr); } }
    .tile-lg { grid-column: span 2; }

    /* Special layout for exactly 5 items */
    .grid5 { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 760px){
      .grid5 { grid-template-columns: repeat(4, 1fr); }
      .cell-A { grid-column: 1 / span 2; grid-row: 1 / span 2; }
      .cell-B { grid-column: 3 / span 1; grid-row: 1; }
      .cell-C { grid-column: 4 / span 1; grid-row: 1; }
      .cell-D { grid-column: 3 / span 1; grid-row: 2; }
      .cell-E { grid-column: 4 / span 1; grid-row: 2; }
    }
    .item { position:relative; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.08); width:300px; }
    .actions { position:absolute; top:8px; right:8px; opacity:0; transform: translateY(-4px); transition: opacity .2s ease, transform .2s ease; }
    .item:hover .actions { opacity:1; transform: translateY(0); }
    .btn-ghost { padding:6px 10px; border-radius:20px; background:rgba(17,17,17,.7); color:#fff; border:none; }
    .btn-ghost:hover { background:#b11a24; }
    .item img, .item video { width:100%; height:auto; display:block; }
    .cap { padding:10px 12px; font-size:14px; color:#444; }

    .card { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:16px; margin-top:10px; }
    .form-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input[type="file"] { padding:8px; }
    input[type="text"] { padding:10px 12px; border:1px solid #ddd; border-radius:8px; }
    button { padding:10px 16px; border:none; border-radius:8px; background:#111; color:#fff; cursor:pointer; }
    button:hover { opacity:.9; }
    .hint { color:#666; font-size:13px; margin-top:6px; }
    .empty { text-align:center; padding:40px 0; color:#666; }
    .messages { margin: 10px 0; }
    .messages .msg { padding:10px 12px; border-radius:8px; margin-bottom:8px; }
    .success { background:#e7f7ee; color:#135f2d; }
    .warning { background:#fff7e6; color:#8a5a00; }
    .error { background:#fdecea; color:#8a1c1c; }

    /* Floating upload button and modal */
    .fab { position:fixed; right:16px; top:16px; z-index:40; width:54px; height:54px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:#111; color:#fff; box-shadow:0 10px 22px rgba(0,0,0,.25); }
    .fab:hover { opacity:.95; transform: translateY(-1px); }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.65); z-index:60; padding: 16px; }
    .modal.open { display:flex; }
    .modal-card { background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px; max-width:720px; width:100%; }
  </style>
</head>
<body>
  <header>
    <h1>{{ gallery.get_occasion_display }} üíå</h1>
    {% if gallery.title %}<div class="sub">{{ gallery.title }}</div>{% endif %}
  </header>

  <div class="wrap">
    <button id="fabUpload" aria-label="–î–æ–±–∞–≤–∏—Ç—å" class="fab">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14"/></svg>
    </button>
    {# —Å–æ–æ–±—â–µ–Ω–∏—è Django messages #}
    <div class="messages">
      {% if messages %}
        {% for m in messages %}
          <div class="msg {{ m.tags }}">{{ m }}</div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
      <div class="modal-card">
        <div class="form-row" style="justify-content: space-between; margin-bottom: 8px;">
          <h2 style="margin:0; font-size:18px;">–î–æ–±–∞–≤–∏—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è</h2>
          <button id="closeUpload" type="button" style="padding:8px 12px; border:none; border-radius:8px; background:#111; color:#fff;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-row" style="align-items:flex-start; gap:12px;">
            <input type="file" name="files" accept="image/*,video/*" multiple required>
            <input type="text" name="caption" placeholder="–ü–æ–¥–ø–∏—Å—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" maxlength="200">
            <input type="number" name="sort_order" placeholder="–ü–æ—Ä—è–¥–æ–∫ (–Ω–∞—á–∏–Ω–∞—è —Å)" min="0" style="padding:10px 12px; border:1px solid #ddd; border-radius:8px; width:170px;">
            {% if need_pin %}
              <input type="text" name="pin" placeholder="PIN –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏" maxlength="12" required>
            {% endif %}
            <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
          <div class="hint">–î–æ–ø—É—Å—Ç–∏–º–æ: —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ. –ú–∞–∫—Å–∏–º—É–º {{ max_mb }} MB –Ω–∞ —Ñ–∞–π–ª.</div>
        </form>
      </div>
    </div>

    {% if media_items %}
      {% if media_items|length == 5 %}
      <div class="grid5">
        {% for item in media_items %}
          <div class="item {% if forloop.counter == 1 %}cell-A{% elif forloop.counter == 2 %}cell-B{% elif forloop.counter == 3 %}cell-C{% elif forloop.counter == 4 %}cell-D{% elif forloop.counter == 5 %}cell-E{% endif %}">
            <div class="actions">
              <form method="post" action="{% url 'media_delete' uuid=gallery.uuid item_id=item.id %}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª?');">
                {% csrf_token %}
                <button type="submit" class="btn-ghost">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </div>
            {% if item.kind == "image" %}
              <img src="{{ item.file.url }}" alt="{{ item.caption }}">
            {% elif item.kind == "video" %}
              <video controls>
                <source src="{{ item.file.url }}" type="{{ item.mime_type }}">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
              </video>
            {% endif %}
            {% if item.caption %}<div class="cap">{{ item.caption }}</div>{% endif %}
          </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="grid">
        {% for item in media_items %}
          <div class="item {% if forloop.first %}tile-lg{% endif %}">
            <div class="actions">
              <form method="post" action="{% url 'media_delete' uuid=gallery.uuid item_id=item.id %}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª?');">
                {% csrf_token %}
                <button type="submit" class="btn-ghost">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </div>
            {% if item.kind == "image" %}
              <img src="{{ item.file.url }}" alt="{{ item.caption }}">
            {% elif item.kind == "video" %}
              <video controls>
                <source src="{{ item.file.url }}" type="{{ item.mime_type }}">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
              </video>
            {% endif %}
            {% if item.caption %}<div class="cap">{{ item.caption }}</div>{% endif %}
          </div>
        {% endfor %}
      </div>
      {% endif %}
    {% else %}
      <div class="empty">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è üíñ</div>
    {% endif %}
  </div>
  <script>
    const fab = document.getElementById('fabUpload');
    const modal = document.getElementById('uploadModal');
    const closeBtn = document.getElementById('closeUpload');
    fab.addEventListener('click', ()=> modal.classList.add('open'));
    closeBtn.addEventListener('click', ()=> modal.classList.remove('open'));
    modal.addEventListener('click', (e)=>{ if(e.target === modal){ modal.classList.remove('open'); }});
  </script>
</body>
</html>
